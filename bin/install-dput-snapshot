#! /bin/bash -eu

# This is just a wrapper around debi & dput (or reprepro)

# Normally invoked as a post-build hook by git-buildpackage -- receives variables see bellow
# via `env' variables, it can be tuned:
# DPUT_TARGETS & DPUT_OPTIONS
# INSTALL_IMMEDIATELY


# When invoked manually, we use:
# MBS_SNAP_TARGETS

# Given as $1 the changes file
# dput it to all in 

#source @@SHAREDIR@@/functions
source /usr/share/build-system/functions.sh
possibly_trace



function usage(){
cat <<EOF
usage: ${0##*/} [+-ufi} [--] ARGS...
dput(1) options basically
-u don't check the signaure
-f force RE-upload
-i install immediatelly
EOF
}

# fixme: ${GBP_BUILD_DIR+../}
BUILD_AREA=${GBP_BUILD_DIR:-../_build-area/}

# make it invocable ...
while getopts :ufi OPT; do
    case $OPT in
	u|+u)
	    DPUT_OPTIONS+="--unchecked "
	    ;;
	f)
	    DPUT_OPTIONS+="--force "
	    ;;
	i)
	    INSTALL_IMMEDIATELY=y
	    ;;
	*)
	    usage
	    exit 2
    esac
done
shift $(( OPTIND - 1 ))
OPTIND=1

if [ $# -gt 0 ]
then
    GBP_CHANGES_FILE=$1
    GBP_BUILD_DIR="/"
fi



# $GBP_BUILD_DIR is the build directory: I don't need it.
cecho green "putting into repositories: ${GBP_CHANGES_FILE-}"

if [ -n "${REPREPRO_BASE_DIR-}" -a -n "${GBP_CHANGES_FILE-}" ]
then
    # fixme: snapshot -> not a big deal if I still get the dist. wrong?
    # --basedir ~/reprepro/
    reprepro --ignore=wrongdistribution  -V \
        include UNRELEASED $GBP_CHANGES_FILE
else
    for TARGET in ${DPUT_TARGETS:-}
    do
	dput $DPUT_OPTIONS $TARGET $GBP_CHANGES_FILE
    done
fi


###  put into Archives:
for target in $;
do
    cecho blue "Uploading to $target"
    if ! debrelease --debs-dir=$BUILD_AREA --dput $target; then
	(echo "Failed to upload to $target"; echo )>&2
    fi
done


# this is even faster:
if [ ${INSTALL_IMMEDIATELY:-n} = "y" ]
then
    cecho green "installing immediately ${GBP_CHANGES_FILE-}"
    if [ -n "${GBP_CHANGES_FILE-}" ]; then
	debi ${DEBI_OPTIONS-} $GBP_CHANGES_FILE
    else
	debi ${DEBI_OPTIONS-} --debs-dir $BUILD_AREA
    fi
else
    echo
    echo "** If you want to install:"
    # cecho gray:
    echo "debi --debs-dir $BUILD_AREA"
fi
